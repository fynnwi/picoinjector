---
title: "Volumes and Concentrations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Volumes and Concentrations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(picoinjector)
library(dplyr)
library(ggplot2)
library(tidyr)
```

In this vignette, calculations to estimate volumes, concentrations and other quantities relevant for the droplet making and picoinjection workflow are documented.

## Volumes

### Tubing

Volume of a cylinder with radius $r$ and height $h$:

$$V = \pi r^2 h$$

```{r}
getCylinderVolume <- function(radius, height) {
  return(pi * radius^2 * height)
}
```



Tubing options


| type   | inner diameter      | outer diameter      |
|--------|---------------------|---------------------|
| Typgon | 0.508 mm (0.020 in) | 1.524 mm (0.060 in) |
| PTFE   | 0.8 mm              | 1.6 mm              |

```{r}
# everything in m
radiusTygon <- 0.508e-3 / 2
radiusPTFE <- 0.8e-3 / 2
```


Plot the tubing volume as a function of tubing length for lengths up to 1 meter:

```{r}
volumes <- tibble::tibble("length" = seq(1,1000)) %>% 
  dplyr::mutate(length = length * 1e-3) %>% # convert into mm
  dplyr::mutate(v_tygon = getCylinderVolume(radiusTygon, length),
                v_ptfe = getCylinderVolume(radiusPTFE, length)) %>%
  tidyr::pivot_longer(c(v_tygon, v_ptfe), names_to = "type", values_to = "volume")
volumes

ggplot(volumes, aes(x = length, y = volume * 1e9, color = type)) + 
  geom_line() + 
  scale_colour_viridis_d(labels = c("PTFE", "Tygon")) + 
  labs(x = "Tubing length [m]",
       y = "Tubing volume [µL]",
       color = "Tubing type") + 
  theme_pretty()
```



Convert flowrate unit µl/h into tubing cm/h:

```{r}
flowrates <- tibble::tibble("ul_h" = seq(0, 100)) %>% 
  dplyr::mutate("Tygon" = ul_h / (getCylinderVolume(radiusTygon, 0.01) * 1e9), 
                "PTFE" = ul_h / (getCylinderVolume(radiusPTFE, 0.01) * 1e9)) %>% 
  tidyr::pivot_longer(!ul_h, names_to = "tubing_type", values_to = "cm_h")
```


```{r}
ggplot(flowrates, aes(x = ul_h, y = cm_h, color = tubing_type)) + 
  geom_line() + 
  scale_color_viridis_d() + 
  theme_pretty() + 
  labs(x = "Flowrate [ul/h]",
       y = "Tubing-length flowrate [cm/h]",
       color = "Tubing type",
       title = "Tubing volume as a function of tubing length")
```



### Droplets

How much liquid is contained in a droplet of diameter $d$?

Volume of a sphere:
$$V = \frac{4}{3} \pi r^3$$

```{r}
getSphereVolume <- function(radius) {
  return(4/3 * pi * radius^3)
}
```


Plot droplet volumes as function of diameter:

```{r}
tibble::tibble("diameter" = seq(10, 100) * 1e-6) %>% # 10-200 µm droplets
  dplyr::mutate("volume" = getSphereVolume(diameter/2)) %>% 
  ggplot(aes(x = diameter*1e6, y = volume * 1e15)) + # y-axis in picoliters
  geom_line() +
  labs(x = "Droplet diameter [µm]",
       y = "Droplet volume [pL]") + 
  theme_pretty()

```


For droplet sizes up to 40 µm:

```{r}
last_plot() + 
  coord_cartesian(xlim = c(10, 40), ylim = c(0, 35))
```




How many droplets are there in x mm of Tygon/PTFE tubing?


```{r}
radiusDroplet <- 15e-6 # 30 micron droplets
```

Assuming close-packing of equal spheres: fraction of space occupied by spheres is

$$\frac{\pi}{3 \sqrt{2}} \approx 0.74048$$

Using this packing density, I can calculate the volume occupied by spheres for a given tubing length.
Dividing by the known volume of a single droplet yields the total number of droplets contained in x meters of tubing, assuming close-packing of equal spheres.

```{r}
getNumberOfClosePackedSpheres <- function(radius, volume) {
  volumeSingleSphere <- 4/3 * pi * radius^3
  packingDensity <- pi/3/sqrt(2)
  return(packingDensity * volume / volumeSingleSphere)
}
```


Plot number of close-packed spheres over tubing length:

```{r}
volumes %>% 
  dplyr::mutate(n_droplets = getNumberOfClosePackedSpheres(radiusDroplet, volume)) %>% 
  ggplot(aes(x = length, y = n_droplets*1e-6, color = type)) +
  geom_line() +
  scale_colour_viridis_d(labels = c("PTFE", "Tygon")) + 
  labs(x = "Tubing length [m]",
       y = "Number of close-packed spheres [million]",
       color = "Tubing type") + 
  theme_pretty()
```






## Concentrations

### Single-cell encapsulation

From Collins et al. 2015:

- when number of encapsulated cells is large and size is significantly smaller than the droplet (e.g. bacterial cells), the number of cells per droplet can be representative of the volumetric concentration of cells
  - number of cells can be approximated by a Gaussian distribution
  - not the case for single-cell analysis
- if cells are distributed randomly in the aqueous phase, the quantity of cells per droplet is determined by Poisson statistics
- probabilistically estimate the proportion of single cells that are encapsulated according to the Poisson distribution, which is applicable in the case where the average cell arrival rate is known and the arrival of individual cells occurs independently from other cells



Poisson distribution:

$$p(k, \lambda) = \frac{\lambda^k e^{-k}}{k!}$$

- $k$ number of particles in a droplet
- $\lambda$ average number of cells per droplet volume


Plot the Poisson distribution for different $\lambda$:

```{r}
tidyr::crossing("k" = seq(0,5),
                "lambda" = c(0.05, 0.25, 0.5, 1, 20)) %>% 
  dplyr::mutate("p" = dpois(k, lambda)) %>% 
  ggplot(aes(x = k, y = p)) + 
  geom_line(aes(color = factor(lambda)), linetype = "dashed") + 
  geom_point(aes(fill = factor(lambda)), shape = 22) + 
  theme_pretty() + 
  labs(title = "Poisson distribution for different values of lambda",
       y = "p(k, lambda)",
       x = "k",
       color = "lambda",
       fill = "lambda")
```





