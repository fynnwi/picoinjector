---
title: "COMSOL Simulations"
output: rmarkdown::html_vignette
bibliography: "bibliography.bib"
vignette: >
  %\VignetteIndexEntry{COMSOL Simulations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(picoinjector)
library(ggplot2)
```


Read the COMSOL file

```{r}
d <- readr::read_table("data/comsol/01_tubing_line_integration_spfU.txt", skip = 1, col_names = c("radius", "length", "pressure", "flowrate"))
d
```


```{r}
d %>% 
  ggplot(aes(x = pressure, y = flowrate, color = factor(radius*2))) + 
  geom_point() + 
  geom_line(aes(linetype = factor(length))) + 
  labs(x = "Pressure difference [Pa]",
       y = "Volumetric flow rate [m^3/s]",
       linetype = "Tubing length [cm]",
       color = "Tubing inner diameter [mm]") + 
  theme_pretty()
```

```{r}
d %>% 
  ggplot(aes(x = radius*2, y = flowrate, color = factor(pressure))) + 
  geom_point() + 
  geom_line(aes(linetype = factor(length))) + 
  labs(x = "Tubing diameter [mm]",
       y = "Volumetric flow rate [m^3/s]",
       linetype = "Tubing length [cm]",
       color = "Pressure difference [Pa]") + 
  theme_pretty()
```



Simulation 02: Flow in Tygon tubing of different lengths at different pressures:

```{r}
d <- readr::read_table("data/comsol/02_tubing_tygon_parametric_sweep.txt", skip = 1, col_names = c("length", "pressure", "flowrate"))
d
```


```{r}
d %>% 
  ggplot(aes(x = pressure, y = flowrate, color = factor(length))) + 
  geom_point() + 
  geom_line()
```

What is the flow predicted by the Hagen-Poisseuille equation?


$$Q = \frac{\Delta p}{R_h} = \frac{\Delta p \pi r^4}{8 \mu l}$$


For a (straight) channel with circular cross-section, the hydraulic resistance is defined as $R_h = \frac{8 \mu L}{\pi r^4}$ with $\mu$ dynamic viscosity, $L$ channel length, and $r$ channel radius [@bruus_theoretical_2008].


Function to evaluate Hagen-Poisseuille equation:

```{r}
mu <- 8.9e-4 # water, 8.9e-4 Pa s
q_hagen_poisseuille <- function(deltaP, radius, length, mu) {
  return(deltaP * pi * radius^4 / (8 * mu * length))
}

# function to convert m^3/s into ml/h
m3s_to_mlh <- function(x) {
  return(x*1e6*3600)
}
```

Flow rate according to HP law vs. COMSOL simulation result:

```{r}
d %>% 
  dplyr::mutate(hagen_poisseuille = q_hagen_poisseuille(pressure*1e5, 0.254e-3, length * 1e-2, mu) %>% 
                  m3s_to_mlh()) %>% 
  dplyr::rename("comsol" = "flowrate") %>% 
  tidyr::pivot_longer(c(comsol, hagen_poisseuille)) %>% 
  ggplot(aes(x = pressure, y = value, color = factor(length), linetype = name)) + 
  geom_point() +
  geom_line() + 
  theme_pretty() + 
  labs(x = "Pressure [bar]",
       y = "Flow rate [ml/h]",
       color = "Tubing length [cm]",
       linetype = "Result")
```


### Parametric sweep over radius:

```{r}
d <- readr::read_table("data/comsol/03_tubing_radius_sweep.txt", skip = 1, col_names = c("radius", "q_numeric")) %>% 
  dplyr::mutate("q_hagen_poisseuille" = q_hagen_poisseuille(10000, radius*1e-3, 0.1, mu))
d %>% 
  tidyr::pivot_longer(c(q_hagen_poisseuille, q_numeric), names_to = "approach", values_to = "flowrate") %>% 
  ggplot(aes(x = radius, y = flowrate*1e6, color = approach)) + 
  geom_line() + 
  geom_point() + 
  scale_color_discrete(labels = c("Hagen-Poisseuille", "Simulation")) + 
  theme_pretty_thesis() + 
  labs(y = "Flow rate [ml/s]",
       x = "Channel radius [mm]",
       color = "Method")
```


Calculate deviations

```{r}
d %>% 
  dplyr::mutate("relative_difference" = (q_numeric - q_hagen_poisseuille) / q_hagen_poisseuille * 100)
```

```{r}
deltaP <- 10000 # Pa 
d <- readr::read_table("data/comsol/04_tubing_radius_sweep_smaller.txt", skip = 1, col_names = c("radius", "q_numeric")) %>% 
  dplyr::mutate("q_hagen_poisseuille" = q_hagen_poisseuille(deltaP, radius*1e-3, 0.1, mu))
d %>% 
  tidyr::pivot_longer(c(q_hagen_poisseuille, q_numeric), names_to = "approach", values_to = "flowrate") %>% 
  ggplot(aes(x = radius, y = flowrate*1e6, color = approach)) + 
  geom_line() + 
  geom_point() + 
  scale_color_discrete(labels = c("Hagen-Poisseuille", "Simulation")) + 
  theme_pretty_thesis() + 
  labs(y = "Flow rate [ml/s]",
       x = "Channel radius [mm]",
       color = "Method")
```


Q = P/R
R = 

Correspondingly, the hydraulic resistance of any of these channel configurations can be computed from flowrate and pressure.
$$Q = \frac{\Delta p}{R_h} \iff R_h = \frac{\Delta p}{Q}$$
```{r}
d %>% 
  dplyr::mutate("r_numeric" = deltaP / q_numeric,
                "r_hagen_poisseuille" = deltaP / q_hagen_poisseuille)
```




## References
