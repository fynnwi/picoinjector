---
title: "FADS Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{FADS Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eva = FALSE
)
```

```{r setup}
library(picoinjector)
library(dplyr)
library(readr)
library(ggplot2)
library(wesanderson)
library(patchwork)
```


## TSV file

Using the LabVIEW software, a TSV file can be recorded during an experiment, where every row corresponds to a droplet that is recognized by the sorter.
For a droplet flowing across the focus spot to be recognized, the signal captured by the PMT has to exceed a defined threshold in terms of amplitude and duration.
This way, droplets can be distinguished from the background signal.

```{r}
fads <- fads_read_tsv("data/fads/220916/pi30v4_0.txt")
fads
```

This function allows to plot the red against the green signal:

```{r}
fads %>% 
  fads_remove_outliers() %>%
  fads_plot_red_green()
```


Same plot, but with hexagonal glyphs:

```{r}
fads %>% 
  fads_remove_outliers() %>%
  fads_plot_red_green_hex()
```


Lets look at the signal width as well:

```{r}
fads %>% 
  # fads_remove_outliers() %>% 
  fads_plot_width()
```


Plot width vs. time:

```{r}
fads %>% 
  # fads_remove_outliers() %>% 
  fads_plot_width_time()
```


Plot signal vs. time:

```{r}
fads %>% 
  fads_remove_outliers() %>% 
  fads_plot_signal_time()
```


Plot droplet frequency over time:

```{r}
fads_plot_frequency(fads)
```


Over the course of this project, I collected many FADS tsv files.
From each of them, I want to generate a comprehensive report containing all the plots shown above with a single function call.
Probably the best way to this, is combining all the ggplot objects into one plot using patchwork:

```{r, fig.widt=20}
p <- fads_generate_report("data/fads/220916/pi30v4_6.txt")
p
```

Do this for all `.txt` files that were generate by the FADS setup:

```{r, eval=FALSE}
fads_reports_for_all("~/nyancat_tsv", "output/fads_data_exploration/")
```




## Picoinjecting cells experiment (2022-12-16)

Convert droplet occupancy into volume
```{r}
occupancy_to_picoliter <- function(occupancy, knownConcentration = 1e8) {
  # concentration in cells/mL
  return(occupancy/knownConcentration*1e9)
}
```

Get the concentration determined via cell counting:

```{r}
counts <- readr::read_csv("data/fads/221216/cellcounts.csv", show_col_types = F)
counts
```


```{r}
concentration <- mean(counts$Count)/0.5e-3 # cells/mL
# account for 10x dilution!
concentration <- concentration*10
concentration
```

Concentration is ~ 9e7, that is 90 mil cells/mL, or 0.09 cells/pl




```{r}
occupancies <- readr::read_tsv("data/fads/221216/occupancy_redmph_0_0085.txt", col_names = c("file", "occupancy"), show_col_types = F)
flowrates <- readr::read_tsv("data/fads/221216/flowrates.txt", show_col_types = F)
```


```{r}
flowrates %>% 
  dplyr::left_join(occupancies, by = "file") %>% 
  dplyr::mutate("volume" = occupancy_to_picoliter(occupancy, concentration)) %>% 
  dplyr::filter(!file %in% paste0("Signal_", 4)) %>% 
  ggplot(aes(x = p_water, y = p_oil)) + 
  # geom_text(aes(label = file), position = position_jitter(height = 4, width = 0)) + 
  geom_point(aes(size = volume, color = volume, shape = factor(q_emulsion))) + 
  theme_pretty_thesis()
```


Estimate oil flow rate from pressure using Hagen-Poisseuille law and estimated hydraulic resistance..

$$R_h =\frac{12 \eta L}{1-0.63(h/w)} \frac{1}{h^3w}$$
For the channel dimensions I use L = 0.5 mm, h = 30 µm, w = 20 µm (approximate length of the most confined channel segment)
```{r}
r_h <-  12 * 4.1e-3 * 0.2e-3 /((1-0.63*(30e-6 / 20e-6))*(30e-6)^3 * 20e-6)
flowrates <- flowrates %>% 
  dplyr::mutate("q_oil_est" = p_oil * 1e2/r_h * 3.6e12) # in ml/h
```

```{r, fig.width = 4.57, fig.height=3.39}
pal <- wes_palette("Zissou1", 100, type = "continuous")

flowrates %>% 
  dplyr::left_join(occupancies, by = "file") %>% 
  dplyr::mutate("volume" = occupancy_to_picoliter(occupancy, concentration)) %>% 
  dplyr::filter(!file %in% paste0("Signal_", 4)) %>% 
  ggplot(aes(x = p_water/(q_oil_est+q_emulsion), y = volume)) + 
  geom_smooth(method = "lm", formula = y~x, linetype = "dashed", color = "black", linewidth = 0.5, se = FALSE) +  
  geom_point(aes(fill = factor(q_emulsion)), shape = 21, size = 4) + 
  theme_pretty_thesis() + 
  scale_fill_manual(values = c("#3B9AB2", "#EBCC2A")) + 
  labs(x = expression("Relative injection pressure: "*p["injection"]/(Q["oil"] + Q["emulsion"])*" [mbar/µL/h]"),
       y = "Injected volume [pL]",
       fill = "Emulsion flow rate [µl/h]",
       title = "Picoinjected volume vs. relative injection pressure")+
  theme_pretty_thesis()
```

```{r, eval=FALSE, fig.width=4.57, fig.height=3.39}
ggsave("output/plots/04_injecting_cells_results.png", width = 4.57, height = 3.39, dpi = 300)
```



### Plot occupancies

Load all data

```{r}
files <- list.files("data/fads/221216/occupancies", full.names = TRUE)
occu <- tibble::tibble()
for (f in files) {
  occu <- occu %>% 
    dplyr::bind_rows(
      readr::read_table(f, col_names = c("n_cells", "n_droplets"), show_col_types = F) %>% 
        dplyr::mutate("file" = stringr::str_extract(basename(f), "Signal_\\d+"))
    )
}
```



```{r}
occu %>% 
  ggplot(aes(x = n_cells, y = n_droplets)) + 
  geom_line() + 
  facet_wrap(~ file, scales = "free")
```


```{r}
occu <- occu %>% 
  group_by(file) %>% 
  mutate("percentage" = n_droplets/sum(n_droplets)) %>% 
  left_join(occupancies, by = "file") %>% 
  mutate("poisson" = dpois(n_cells, occupancy))
occu
```



```{r, fig.width=9.31, fig.height=3.39}
occu %>% 
  tidyr::pivot_longer(c(percentage, poisson)) %>% 
  mutate("file" = factor(file, levels = paste0("Signal_", seq(0,10)))) %>% 
  ggplot(aes(x = n_cells, y = value)) + 
  geom_line(aes(color = name), linewidth = 0.3) + 
  geom_point(aes(color = name, shape = name)) + 
  facet_wrap(~file, scales = "free", nrow = 2) + 
  theme_pretty_thesis() + 
  scale_color_manual(values = c("#0065bd", "black"), labels = c("Observed droplet occupancy", "Poisson distribution")) +
  scale_shape_manual(values = c(1,2), labels = c("Observed droplet occupancy", "Poisson distribution")) +

  labs(x = "Droplet occupancy",
       y = "Fraction of total population") + 
  # guides(color = guide_legend(title = NULL)) +
  theme(legend.position = "bottom", legend.direction = "horizontal", legend.box.margin = margin(), legend.title = element_blank(), legend.key.width = unit(0.5, "cm"))
```


```{r, eval=FALSE, fig.width=4.57, fig.height=3.39}
ggsave("output/plots/04_injecting_cells_poisson.png", width = 9.31, height = 3.39, dpi = 300)
```




```{r}
tidyr::crossing("k" = seq(0,10),
                "lambda" = c(0.05, 0.25, 1, 2, 5, 20)) %>% 
  dplyr::mutate("p" = dpois(k, lambda)) %>% 
  ggplot(aes(x = k, y = p)) + 
  geom_line(aes(color = factor(lambda)), linetype = "dashed") + 
  geom_point(aes(fill = factor(lambda)), shape = 22) + 
  scale_x_continuous(breaks = seq(0,10)) + 
  theme_pretty() + 
  labs(title = "Poisson distribution for different values of lambda",
       y = "p(k, lambda)",
       x = "k",
       color = "lambda",
       fill = "lambda")
```








### Thesis plots

```{r}
textwidth <- 6.10356
```

04_bacteria_results


```{r, fig.width = 4.57, fig.height=3.39}
p1 <- flowrates %>% 
  dplyr::left_join(occupancies, by = "file") %>% 
  dplyr::mutate("volume" = occupancy_to_picoliter(occupancy, concentration)) %>% 
  dplyr::filter(!file %in% paste0("Signal_", 4)) %>% 
  ggplot(aes(x = p_water/(q_oil_est+q_emulsion), y = volume)) + 
  geom_smooth(method = "lm", formula = y~x, linetype = "dashed", color = "black", linewidth = 0.5, se = FALSE) +  
  geom_point(aes(fill = factor(q_emulsion)), shape = 21, size = 4) + 
  theme_pretty_thesis2() + 
  guides(fill = guide_legend(direction = "horizontal", title.position = "top"))+
  scale_fill_manual(values = c("#def5e5", "#357ba2"))+
  labs(x = "Relative injection pressure [mbar/µL/h]",
       y = "Injected volume [pL]",
       fill = "Emulsion flow rate [µl/h]")

p2 <- occu %>% 
  dplyr::filter(file == "Signal_5") %>% 
  tidyr::pivot_longer(c(percentage, poisson)) %>% 
  mutate("file" = factor(file, levels = paste0("Signal_", seq(0,10)))) %>% 
  ggplot(aes(x = n_cells, y = value)) + 
  geom_line(aes(color = name), linewidth = 0.3) + 
  geom_point(aes(color = name, shape = name)) + 
  theme_pretty_thesis2() + 
  scale_color_manual(values = c("#0065bd", "black"), labels = c("Observed droplet occupancy", "Poisson distribution")) +
  scale_shape_manual(values = c(1,2), labels = c("Observed droplet occupancy", "Poisson distribution")) +

  labs(x = "Droplet occupancy",
       y = "Fraction of total population") +
  # guides(color = guide_legend(title = NULL)) +
  theme(legend.position = c(1,1), legend.justification = c(1,1),legend.margin = margin(t=0.1, l=0.2, r = 0.2, b = 0.2, unit = "cm"),  legend.title = element_blank(), legend.key.width = unit(0.5, "cm"))
p1
p2
```


```{r, eval=FALSE, fig.width=6.14, fig.height=3.09}
p1 + theme(plot.margin = margin(r = 0.4, unit = "cm"))+p2 + 
  plot_annotation(tag_levels = "A",
                  theme = theme(plot.margin = margin(1,1,1,1, unit = "mm")))
ggsave("output/thesis_plots/04_bacteria_results.pdf", width = textwidth, height = textwidth/2)
ggsave("/home/fynn/Code/masterthesis/figures/04_bacteria_results.pdf", width = textwidth, height = textwidth/2)
```



si_bacteria_poisson_occupancy

```{r, fig.width=6.14, fig.height=4.1}
p <- occu %>% 
  tidyr::pivot_longer(c(percentage, poisson)) %>% 
  mutate("file" = factor(file, levels = paste0("Signal_", seq(0,10)))) %>% 
  ggplot(aes(x = n_cells, y = value)) + 
  geom_line(aes(color = name), linewidth = 0.3) + 
  geom_point(aes(color = name, shape = name)) + 
  facet_wrap(~file, nrow = 2) + 
  theme_pretty_thesis() + 
  scale_color_manual(values = c("#0065bd", "black"), labels = c("Observed droplet occupancy", "Poisson distribution")) +
  scale_shape_manual(values = c(1,2), labels = c("Observed droplet occupancy", "Poisson distribution")) +

  labs(x = "Droplet occupancy",
       y = "Fraction of total population") + 
  # guides(color = guide_legend(title = NULL)) +
  theme(legend.position = "bottom", legend.direction = "horizontal", legend.box.margin = margin(), legend.title = element_blank(), legend.key.width = unit(0.5, "cm"),
        plot.margin = margin(1,1,1,1))
p
```



```{r, eval=FALSE, fig.width=6.14, fig.height=3.09}
ggsave("output/thesis_plots/si_bacteria_poisson_occupancy.pdf", width = textwidth, height = textwidth/3*2)
ggsave("/home/fynn/Code/masterthesis/figures/si_bacteria_poisson_occupancy.pdf", width = textwidth, height = textwidth/3*2)
```


04_fads_individual_cells

```{r}
signal <- readr::read_table("/run/media/fynn/T7/masterthesis/Nyancat/20221216/matlab_analysis/Signal_8_ggplot_wav.txt", show_col_types = F)
redPeaks <- readr::read_table("/run/media/fynn/T7/masterthesis/Nyancat/20221216/matlab_analysis/Signal_8_ggplot_redpeaks.txt", show_col_types = F,
                              col_names = c("t_start", "t_max", "t_end", "voltage", "width", "spacing", "area")) %>% 
  dplyr::mutate("channel" = "red")
greenPeaks <- readr::read_table("/run/media/fynn/T7/masterthesis/Nyancat/20221216/matlab_analysis/Signal_8_ggplot_greenpeaks.txt", show_col_types = F,
                              col_names = c("t_start", "t_max", "t_end", "voltage", "width", "spacing", "area")) %>% 
  dplyr::mutate("channel" = "green")

peaks <- dplyr::bind_rows(redPeaks, greenPeaks)
```


Assemble plot:

```{r, fig.width=3, fig.height=3}
p1 <- signal %>% 
  dplyr::filter(t > 95.66 & t < 95.69) %>% 
  tidyr::pivot_longer(-t) %>% 
  ggplot(aes(x = t, y = value, color = name)) + 
  geom_line(linewidth = 0.5) + 
  geom_point(data = peaks, aes(x = t_max, y = voltage, color = channel), shape = 1, size = 2) + 
  scale_color_manual(values = c("#6fb142", "#ad232b"), labels = c("green TODO", "red")) +
  theme_pretty_thesis2() + 
  labs(x = "Time [s]",
       y = "PMT signal [V]",
       color = "Photomultiplier tube") +
  theme(legend.position = c(0,1), legend.justification = c(0,1))+
  coord_cartesian(xlim = c(95.66, 95.69), ylim = c(0, 0.05))
p1
```


```{r, fig.width=3}
p2 <- signal %>% 
  dplyr::filter(t > 99 & t < 100) %>% 
  tidyr::pivot_longer(-t) %>% 
  ggplot(aes(x = t, y = value, color = name)) + 
  geom_line(linewidth = 0.5, show.legend = F) + 
  geom_point(data = peaks, aes(x = t_max, y = voltage, color = channel), shape = 1, size = 2, show.legend = F) + 
  scale_color_manual(values = c("#6fb142", "#ad232b"), labels = c("green TODO", "red")) +
  theme_pretty_thesis2() + 
  labs(x = "Time [s]",
       y = "PMT signal [V]",
       color = "Photomultiplier tube") +
  theme(legend.position = c(0,1), legend.justification = c(0,1))+
  coord_cartesian(xlim = c(99.5125, 99.518), ylim = c(0, 0.05))
p2
```


```{r, eval=FALSE, fig.width=6.14, fig.height=3.09}
p1 + theme(plot.margin = margin(r = 0.4, unit = "cm"))+p2 + 
  plot_annotation(tag_levels = "A",
                  theme = theme(plot.margin = margin(1,1,1,1, unit = "mm")))
ggsave("output/thesis_plots/04_fads_individual_cells.pdf", width = textwidth, height = textwidth/2)
ggsave("/home/fynn/Code/masterthesis/figures/04_fads_individual_cells.pdf", width = textwidth, height = textwidth/2)
```


## Picoinjecting Atto488 into resorufin droplets (2022-11-17)

Combine all available data into one tibble:

```{r}
greenAll <- fads_read_all("data/fads/221117/", "_barcode.txt$")
redAll <- fads_read_all("data/fads/221117/", "_injected.txt$")
```



```{r}
greenAll %>% 
  dplyr::filter(injected == 1,
                width < 0.001) %>% 
  ggplot(aes(x = width, fill = file)) + 
  geom_histogram(bins = 50, alpha = 0.5, position = "identity") + 
  theme_pretty_thesis() + 
  labs(x = "Droplet width [ms]",
       y = "Droplets",
       fille = "File")
```


```{r}
greenAll %>% 
  dplyr::filter(width < 0.001) %>% 
  ggplot(aes(x = width, fill = factor(injected))) + 
  geom_histogram(bins  =100, alpha = 0.5, position = "identity")  +
  theme_pretty_thesis() + 
  facet_wrap(~ file) + 
  labs(title = "Green droplet widths",
       x = "Width [ms]",
       y = "Droplets",
       fill = "Injected")
```

False droplets can be distinguished by their width:

```{r}
redAll %>% 
  dplyr::filter(width < 0.0015) %>% 
  ggplot(aes(x = width, fill = factor(is_false_drop))) + 
  geom_histogram(bins  =100, alpha = 0.5, position = "identity")  +
  theme_pretty_thesis() + 
  facet_wrap(~ file)
```

Another interesting observation that confirms the quantitative accuracy of laser-based droplet analysis is the fact that while injected droplets increase in size and thus generate a wider signal in the PMT, the signal power, i.e. the area under a signal peak stays the same.
Therefore, the signal arriving in a PMT can be interpreted as a direct measure of the amount of dye inside a droplet.


```{r}
greenAll %>% 
  dplyr::filter(area < 3e-5) %>% 
  ggplot(aes(x = area, fill = factor(injected))) + 
  geom_histogram(bins  =100, alpha = 0.5, position = "identity")  +
  theme_pretty_thesis() + 
  facet_wrap(~ file) + 
  labs(title = "Green droplets signal area",
       x = "Signal area [V*s]",
       y = "Number of droplets",
       fill = "Injected")
```


Calculate some averages:

```{r}
greenAll %>% 
  dplyr::group_by(file) %>% 
  dplyr::summarise("width_mean" = mean(width),
                   "width_sd" = sd(width),
                   "area_mean" = mean(area),
                   "area_sd" = sd(area),
                   "injected_mean" = mean(injected))
```


```{r}
greenAll %>% 
  dplyr::group_by(file, injected) %>% 
  dplyr::summarise("width_mean" = mean(width),
                   "width_sd" = sd(width),
                   "area_mean" = mean(area),
                   "area_sd" = sd(area),
                   "injected_mean" = mean(injected))
```




Can I somehow translate width into volume?

Yes: by comparting width of non-injected droplets.
But what if these are not injected due to being too small?





Really cool: The droplet width changes due to picoinjection, but not the area of the generated signal, emphasizing how quantitative this method is.
It seems it can be used to really measure the _amount_ of dye inside a droplet. (See Signal5)

